// Asegurar que las librer√≠as se carguen
const { jsPDF } = window.jspdf;

// ----------------------------------------------------
// DATOS INICIALES Y ESTRUCTURA DE LA APLICACI√ìN
// ----------------------------------------------------

// Datos iniciales - CONFIGURACI√ìN COMPLETA
let configuracion = {
    tiposEvento: [
        { id: 1, nombre: "Bodas", emoji: 'üíç' },
        { id: 2, nombre: "Cumplea√±os", emoji: 'üéÇ' },
        { id: 3, nombre: "Corporativo", emoji: 'üíº' },
        { id: 4, nombre: "Baby Shower", emoji: 'üë∂' },
        { id: 5, nombre: "Otro", emoji: '‚ú®' }
    ],
    tematicasEvento: [
        { id: 1, nombre: "Barbie", emoji: 'üë∏' },
        { id: 2, nombre: "Patrulla Canina", emoji: 'üêï' },
        { id: 3, nombre: "Superh√©roes", emoji: 'ü¶∏' },
        { id: 4, nombre: "Princesas", emoji: 'üëë' },
        { id: 5, nombre: "Mariposas", emoji: 'ü¶ã' }
    ],
    paquetes: [
        { id: 1, nombre: "Globo Azul", precio: 1200, emoji: 'üíô', cantidad: 0, color: "Azul" },
        { id: 2, nombre: "Globo Dorado", precio: 1500, emoji: '‚ú®', cantidad: 0, color: "Dorado" },
        { id: 3, nombre: "Globo Blanco", precio: 1000, emoji: '‚òÅÔ∏è', cantidad: 0, color: "Blanco" },
        { id: 4, nombre: "Globo Rosa", precio: 1300, emoji: 'üíñ', cantidad: 0, color: "Rosa" }
    ],
    accesorios: [
        { id: 1, nombre: "Mampara Circular", precio: 800, emoji: 'üñºÔ∏è', cantidad: 0 },
        { id: 2, nombre: "Cilindro Decorativo", precio: 400, emoji: 'üè∫', cantidad: 0 },
        { id: 3, nombre: "Mesa Principal", precio: 300, emoji: 'ü™ë', cantidad: 0 },
        { id: 4, nombre: "Sillas Tiffany (x10)", precio: 1500, emoji: 'ü™ë', cantidad: 0 },
        { id: 5, nombre: "Alfombra Roja", precio: 600, emoji: 'üü•', cantidad: 0 }
    ],
    flores: [
        { id: 1, nombre: "Rosas Rojas", precio: 150, emoji: 'üåπ', cantidad: 0, color: "Rojo" },
        { id: 2, nombre: "Lirios Blancos", precio: 120, emoji: '‚ö™', cantidad: 0, color: "Blanco" },
        { id: 3, nombre: "Tulipanes Rosas", precio: 100, emoji: 'üå∑', cantidad: 0, color: "Rosa" },
        { id: 4, nombre: "Girasoles", precio: 130, emoji: 'üåª', cantidad: 0, color: "Amarillo" },
        { id: 5, nombre: "Orqu√≠deas Moradas", precio: 200, emoji: 'üå∏', cantidad: 0, color: "Morado" }
    ],
    arreglos: [
        { id: 1, nombre: "Centro de Mesa Cl√°sico", precio: 2500, emoji: 'üíê', cantidad: 0 },
        { id: 2, nombre: "Ramo Novia Premium", precio: 3500, emoji: 'üíÆ', cantidad: 0 },
        { id: 3, nombre: "Arreglo para Pared", precio: 1800, emoji: 'üñºÔ∏è', cantidad: 0 },
        { id: 4, nombre: "Guirnalda Floral", precio: 2200, emoji: 'üéÄ', cantidad: 0 }
    ],
    manoObraPorcentaje: 30,
    manoObraMontoManual: 0,
    tipoManoObra: "porcentaje" // "porcentaje" o "manual"
};

// Configuraci√≥n de visualizaci√≥n en PDF
let configPDF = {
    mostrarManoObra: true,
    mostrarTransporte: true,
    mostrarDetalleMateriales: true,
    mostrarCostoMateriales: true,
    mostrarPresupuestoSimple: false
};

// Informaci√≥n completa de la cotizaci√≥n
let cotizacion = {
    currentStep: 1,
    cliente: {
        nombre: '', telefono: '', email: '', fechaEvento: '', lugarEvento: '', notas: ''
    },
    tipoEvento: '',
    tematicaEvento: '',
    tipoServicio: '', // "decoracion" o "flores"
    // Inicializar art√≠culos de cotizaci√≥n como copia de la configuraci√≥n base
    articulos: {
        paquetes: JSON.parse(JSON.stringify(configuracion.paquetes)),
        accesorios: JSON.parse(JSON.stringify(configuracion.accesorios)),
        flores: JSON.parse(JSON.stringify(configuracion.flores)),
        arreglos: JSON.parse(JSON.stringify(configuracion.arreglos)),
        manuales: [] // { id, nombre, precioUnitario, cantidad }
    },
    costos: {
        materiales: 0,
        transporte: 0,
        manoObra: 0,
        manoObraPorcentaje: configuracion.manoObraPorcentaje,
        manoObraMontoManual: configuracion.manoObraMontoManual,
        tipoManoObra: configuracion.tipoManoObra,
        total: 0
    }
};

let manualItemIdCounter = 1;
let configIdCounter = 1000;

// FUNCI√ìN PARA FORMATEAR MONEDA DOMINICANA
function formatoMonedaRD(monto) {
    if (isNaN(monto) || monto === null) monto = 0;
    const numero = parseFloat(monto);
    return `RD$${numero.toLocaleString('es-DO', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    })}`;
}

// ----------------------------------------------------
// INICIALIZACI√ìN Y EVENT LISTENERS
// ----------------------------------------------------

document.addEventListener('DOMContentLoaded', function() {
    cargarConfiguracion();
    inicializarEventListeners();
    cargarFechaActual();
    cargarSelects();
    updateStepUI();
    renderizarArticulos('paquetes');
    renderizarConfiguracion();
    actualizarResumen();
    actualizarConfigPDF();
    actualizarVistaPreviaPDF();
});

function cargarFechaActual() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('fecha-evento').value = today;
}

function cargarSelects() {
    // Cargar tipos de evento
    const selectTipoEvento = document.getElementById('tipo-evento');
    selectTipoEvento.innerHTML = '<option value="">Seleccione un tipo</option>';
    configuracion.tiposEvento.forEach(tipo => {
        const option = document.createElement('option');
        option.value = tipo.nombre;
        option.textContent = `${tipo.emoji} ${tipo.nombre}`;
        selectTipoEvento.appendChild(option);
    });

    // Cargar tem√°ticas de evento
    const selectTematica = document.getElementById('tematica-evento');
    selectTematica.innerHTML = '<option value="">Seleccione una tem√°tica</option>';
    configuracion.tematicasEvento.forEach(tematica => {
        const option = document.createElement('option');
        option.value = tematica.nombre;
        option.textContent = `${tematica.emoji} ${tematica.nombre}`;
        selectTematica.appendChild(option);
    });
}

function inicializarEventListeners() {
    // Escuchar cambios en los inputs del Paso 1 para actualizar resumen
    ['cliente-nombre', 'fecha-evento', 'tipo-evento', 'cliente-notas', 'lugar-evento', 'cliente-telefono', 'cliente-email', 'tematica-evento'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.addEventListener('input', guardarDatosPaso1);
    });
    
    // Escuchar cambios en tipo de evento
    document.getElementById('tipo-evento').addEventListener('change', function() {
        guardarDatosPaso1();
        const esOtro = this.value === "Otro";
        document.getElementById('otro-evento-container').style.display = esOtro ? 'block' : 'none';
        if (!esOtro) document.getElementById('otro-evento').value = '';
    });
    
    // Escuchar cambios en tem√°tica
    document.getElementById('tematica-evento').addEventListener('change', function() {
        guardarDatosPaso1();
        const esOtra = this.value === "Otra";
        document.getElementById('otra-tematica-container').style.display = esOtra ? 'block' : 'none';
        if (!esOtra) document.getElementById('otra-tematica').value = '';
    });
    
    // Escuchar cambios en los inputs del Paso 3
    document.getElementById('costo-transporte').addEventListener('input', (e) => actualizarCostoManual('transporte', e.target.value));
    document.getElementById('porcentaje-mano-obra').addEventListener('input', (e) => actualizarCostoManual('manoObraPorcentaje', e.target.value));
    document.getElementById('monto-mano-obra-manual').addEventListener('input', (e) => actualizarCostoManual('manoObraMontoManual', e.target.value));
    
    // Escuchar cambios en checkboxes de PDF
    document.querySelectorAll('.pdf-config-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            actualizarConfigPDF();
            actualizarVistaPreviaPDF();
        });
    });
}

// Actualizar configuraci√≥n PDF
function actualizarConfigPDF() {
    configPDF.mostrarManoObra = document.getElementById('mostrar-mano-obra').checked;
    configPDF.mostrarTransporte = document.getElementById('mostrar-transporte').checked;
    configPDF.mostrarDetalleMateriales = document.getElementById('mostrar-detalle-materiales').checked;
    configPDF.mostrarCostoMateriales = document.getElementById('mostrar-costo-materiales').checked;
    configPDF.mostrarPresupuestoSimple = document.getElementById('mostrar-presupuesto-simple').checked;
    
    // Actualizar indicador en bot√≥n de PDF
    const indicador = document.getElementById('pdf-mode-indicator');
    if (configPDF.mostrarPresupuestoSimple) {
        indicador.textContent = "üìã Modo Presupuesto Simple";
    } else {
        indicador.textContent = "üìä Modo Detallado";
    }
    
    actualizarResumen(); // Recalcular el total cuando cambia la configuraci√≥n
}

function actualizarVistaPreviaPDF() {
    const preview = document.getElementById('preview-content');
    const totalArticulos = contarArticulosTotales();
    
    let contenido = `<strong>üìÑ Vista previa de la cotizaci√≥n:</strong><br>`;
    
    if (configPDF.mostrarPresupuestoSimple) {
        contenido += `‚úÖ <strong>Modo Presupuesto Simple activado</strong><br>`;
        contenido += `‚Ä¢ Solo se mostrar√°n los art√≠culos seleccionados<br>`;
        contenido += `‚Ä¢ No se mostrar√°n precios individuales<br>`;
        contenido += `‚Ä¢ Total final: ${formatoMonedaRD(cotizacion.costos.total)}<br>`;
    } else {
        contenido += `üìä <strong>Modo Detallado</strong><br>`;
        if (configPDF.mostrarDetalleMateriales) contenido += `‚Ä¢ Lista de materiales con cantidades<br>`;
        if (configPDF.mostrarCostoMateriales) contenido += `‚Ä¢ Costo de materiales desglosado<br>`;
        if (configPDF.mostrarManoObra) contenido += `‚Ä¢ Mano de obra incluida<br>`;
        if (configPDF.mostrarTransporte) contenido += `‚Ä¢ Transporte incluido<br>`;
    }
    
    contenido += `<br>üì¶ <strong>Resumen:</strong><br>`;
    contenido += `‚Ä¢ ${totalArticulos} art√≠culo(s) seleccionado(s)<br>`;
    contenido += `‚Ä¢ Cliente: ${cotizacion.cliente.nombre || 'No especificado'}<br>`;
    contenido += `‚Ä¢ Evento: ${cotizacion.tipoEvento || 'No especificado'}<br>`;
    
    preview.innerHTML = contenido;
}

// ----------------------------------------------------
// NUEVAS FUNCIONES PARA EL HTML ACTUALIZADO
// ----------------------------------------------------

function cambiarTipoServicio() {
    const tipoServicio = document.getElementById('tipo-servicio').value;
    cotizacion.tipoServicio = tipoServicio;
    
    // Ocultar/mostrar tabs seg√∫n el tipo de servicio
    const tabsContainer = document.getElementById('tabs-container');
    const tituloPaso2 = document.getElementById('titulo-paso-2');
    
    if (tipoServicio === 'flores') {
        tituloPaso2.textContent = "2. Selecci√≥n de Flores y Arreglos";
        
        // Cambiar tabs para servicio de flores
        tabsContainer.innerHTML = `
            <button class="tab-button active" data-tab="flores" onclick="switchTab('flores')">üå∏ Flores por Unidad</button>
            <button class="tab-button" data-tab="arreglos" onclick="switchTab('arreglos')">üíê Arreglos Florales</button>
            <button class="tab-button" data-tab="manual" onclick="switchTab('manual')">‚úçÔ∏è Art√≠culo Manual</button>
        `;
        
        // Cambiar t√≠tulos en resumen
        document.getElementById('resumen-titulo1').textContent = "Flores:";
        document.getElementById('resumen-titulo2').textContent = "Arreglos:";
        
        // Mostrar tab de flores por defecto
        switchTab('flores');
    } else {
        tituloPaso2.textContent = "2. Selecci√≥n de Art√≠culos";
        
        // Restaurar tabs para decoraci√≥n
        tabsContainer.innerHTML = `
            <button class="tab-button active" data-tab="paquetes" onclick="switchTab('paquetes')">üéà Globos y Paquetes</button>
            <button class="tab-button" data-tab="accesorios" onclick="switchTab('accesorios')">üõãÔ∏è Accesorios</button>
            <button class="tab-button" data-tab="manual" onclick="switchTab('manual')">‚úçÔ∏è Art√≠culo Manual</button>
        `;
        
        // Restaurar t√≠tulos en resumen
        document.getElementById('resumen-titulo1').textContent = "Globos:";
        document.getElementById('resumen-titulo2').textContent = "Accesorios:";
        
        // Mostrar tab de paquetes por defecto
        switchTab('paquetes');
    }
    
    actualizarResumen();
}

function cambiarTematicaEvento() {
    const tematica = document.getElementById('tematica-evento').value;
    cotizacion.tematicaEvento = tematica;
    
    // Si se selecciona "Otra", mostrar el input para especificar
    const esOtra = tematica === "Otra";
    document.getElementById('otra-tematica-container').style.display = esOtra ? 'block' : 'none';
    
    guardarDatosPaso1();
}

function filtrarFloresPorColor() {
    const colorSeleccionado = document.getElementById('filtro-color-flores').value;
    const floresContainer = document.getElementById('flores-container');
    
    if (!floresContainer) return;
    
    floresContainer.innerHTML = '';
    
    const floresFiltradas = colorSeleccionado === 'todos' 
        ? cotizacion.articulos.flores 
        : cotizacion.articulos.flores.filter(flor => flor.color === colorSeleccionado);
    
    floresFiltradas.forEach(flor => {
        const isSelected = flor.cantidad > 0;
        const card = document.createElement('div');
        card.className = `item-card ${isSelected ? 'selected' : ''}`;
        card.id = `flores-${flor.id}`;
        card.innerHTML = `
            <div class="item-details" onclick="toggleArticulo('flores', ${flor.id})">
                <h4>${flor.emoji || 'üå∏'} ${flor.nombre}</h4>
                <p>Costo unitario: ${formatoMonedaRD(flor.precio)}</p>
                <p style="font-size: 0.8em; color: ${flor.color === 'Rojo' ? '#e74c3c' : flor.color === 'Blanco' ? '#7f8c8d' : '#9b59b6'};">Color: ${flor.color}</p>
            </div>
            <div class="item-footer">
                <span class="price">${formatoMonedaRD(flor.precio * flor.cantidad)}</span>
                <div class="quantity-control">
                    <button onclick="updateCantidad('flores', ${flor.id}, -1)">-</button>
                    <input type="number" value="${flor.cantidad}" min="0" 
                            oninput="updateCantidadInput('flores', ${flor.id}, this.value)">
                    <button onclick="updateCantidad('flores', ${flor.id}, 1)">+</button>
                </div>
            </div>
        `;
        floresContainer.appendChild(card);
    });
}

function cambiarTipoManoObra() {
    const tipo = document.getElementById('tipo-mano-obra').value;
    cotizacion.costos.tipoManoObra = tipo;
    
    // Mostrar/ocultar los contenedores apropiados
    document.getElementById('mano-obra-porcentaje-container').style.display = 
        tipo === 'porcentaje' ? 'block' : 'none';
    document.getElementById('mano-obra-manual-container').style.display = 
        tipo === 'manual' ? 'block' : 'none';
    
    actualizarResumen();
}

// ----------------------------------------------------
// CONTROL DE PASOS Y VALIDACI√ìN
// ----------------------------------------------------

function nextStep() {
    if (cotizacion.currentStep === 1) {
        if (!validarPaso1()) return;
        guardarDatosPaso1();
    } else if (cotizacion.currentStep === 2) {
        // Se puede a√±adir l√≥gica de validaci√≥n para el paso 2 aqu√≠ si es necesario
    }
    
    if (cotizacion.currentStep < 3) {
        cotizacion.currentStep++;
        updateStepUI();
    }
}

function prevStep() {
    if (cotizacion.currentStep > 1) {
        cotizacion.currentStep--;
        updateStepUI();
    }
}

function updateStepUI() {
    const steps = [
        document.getElementById('step-1'),
        document.getElementById('step-2'),
        document.getElementById('step-3')
    ];
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const progress = document.getElementById('progress');
    const generarBtn = document.getElementById('generar-cotizacion');

    steps.forEach((step, index) => {
        step.style.display = (index + 1 === cotizacion.currentStep) ? 'block' : 'none';
    });
    
    prevBtn.style.display = cotizacion.currentStep > 1 ? 'inline-flex' : 'none';
    
    if (cotizacion.currentStep === 3) {
        nextBtn.style.display = 'none';
        actualizarVistaPreviaPDF(); // Actualizar vista previa cuando se entra al paso 3
    } else {
        nextBtn.style.display = 'inline-flex';
        nextBtn.textContent = 'Siguiente ‚Üí';
    }
    
    // Habilitar/Deshabilitar el bot√≥n de PDF
    generarBtn.disabled = cotizacion.currentStep !== 3 || cotizacion.costos.total === 0;

    const progressPercent = (cotizacion.currentStep / 3) * 100;
    progress.style.width = `${progressPercent}%`;

    if (cotizacion.currentStep === 2) {
        const activeTabButton = document.querySelector('.tabs .tab-button.active');
        const activeTab = activeTabButton ? activeTabButton.dataset.tab : (cotizacion.tipoServicio === 'flores' ? 'flores' : 'paquetes');
        switchTab(activeTab);
        renderizarArticulosManuales();
    } else if (cotizacion.currentStep === 3) {
        // Asegurar que los inputs del paso 3 reflejen los datos actuales
        document.getElementById('costo-transporte').value = cotizacion.costos.transporte;
        document.getElementById('porcentaje-mano-obra').value = cotizacion.costos.manoObraPorcentaje;
        document.getElementById('monto-mano-obra-manual').value = cotizacion.costos.manoObraMontoManual;
        document.getElementById('tipo-mano-obra').value = cotizacion.costos.tipoManoObra;
        
        // Actualizar contenedores seg√∫n tipo de mano de obra
        cambiarTipoManoObra();
    }
    actualizarResumen();
}

// ----------------------------------------------------
// PASO 1: INFORMACI√ìN DEL CLIENTE
// ----------------------------------------------------

function validarPaso1() {
    const nombre = document.getElementById('cliente-nombre').value.trim();
    const fecha = document.getElementById('fecha-evento').value.trim();
    const tipo = document.getElementById('tipo-evento').value;
    const servicio = document.getElementById('tipo-servicio').value;

    if (!nombre || !fecha || !tipo || !servicio) {
        mostrarNotificaci√≥n('‚ö†Ô∏è Faltan campos obligatorios: Nombre del Cliente, Fecha del Evento, Tipo de Evento y Tipo de Servicio.', 'warning');
        return false;
    }
    
    // Validar si es "Otro" tipo de evento
    if (tipo === "Otro") {
        const otroEvento = document.getElementById('otro-evento').value.trim();
        if (!otroEvento) {
            mostrarNotificaci√≥n('‚ö†Ô∏è Debe especificar el tipo de evento.', 'warning');
            return false;
        }
    }
    
    // Validar si es "Otra" tem√°tica
    const tematica = document.getElementById('tematica-evento').value;
    if (tematica === "Otra") {
        const otraTematica = document.getElementById('otra-tematica').value.trim();
        if (!otraTematica) {
            mostrarNotificaci√≥n('‚ö†Ô∏è Debe especificar la tem√°tica del evento.', 'warning');
            return false;
        }
    }

    return true;
}

function guardarDatosPaso1() {
    cotizacion.cliente.nombre = document.getElementById('cliente-nombre').value.trim();
    cotizacion.cliente.telefono = document.getElementById('cliente-telefono').value.trim();
    cotizacion.cliente.email = document.getElementById('cliente-email').value.trim();
    cotizacion.cliente.fechaEvento = document.getElementById('fecha-evento').value.trim();
    cotizacion.cliente.lugarEvento = document.getElementById('lugar-evento').value.trim();
    cotizacion.cliente.notas = document.getElementById('cliente-notas').value.trim();
    
    const tipoEvento = document.getElementById('tipo-evento').value;
    if (tipoEvento === "Otro") {
        cotizacion.tipoEvento = document.getElementById('otro-evento').value.trim();
    } else {
        cotizacion.tipoEvento = tipoEvento;
    }
    
    const tematica = document.getElementById('tematica-evento').value;
    if (tematica === "Otra") {
        cotizacion.tematicaEvento = document.getElementById('otra-tematica').value.trim();
    } else {
        cotizacion.tematicaEvento = tematica;
    }
    
    aplicarTema(cotizacion.tipoEvento);
    actualizarResumen();
}

function aplicarTema(tipo) {
    const body = document.body;
    // Eliminar temas anteriores
    body.className = body.className.split(' ').filter(className => !className.startsWith('theme-')).join(' ');

    // Aplicar nuevo tema si existe
    if (tipo) {
        const temaNormalizado = tipo.toLowerCase()
            .replace(/ /g, '-')
            .replace(/[√°√©√≠√≥√∫]/g, letra => {
                const mapa = { '√°': 'a', '√©': 'e', '√≠': 'i', '√≥': 'o', '√∫': 'u' };
                return mapa[letra] || letra;
            });
        body.classList.add(`theme-${temaNormalizado}`);
    }
}

// ----------------------------------------------------
// PASO 2: SELECCI√ìN DE ART√çCULOS
// ----------------------------------------------------

function switchTab(tabName) {
    // Ocultar todos los contenidos de tabs
    document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
    });
    // Desactivar todos los botones
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });

    // Mostrar el contenido activo y activar el bot√≥n
    const activeContent = document.getElementById(`tab-${tabName}`);
    const activeBtn = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
    
    if (activeContent) activeContent.style.display = 'block';
    if (activeBtn) activeBtn.classList.add('active');
    
    // Renderizar los art√≠culos correspondientes
    if (tabName === 'paquetes' || tabName === 'accesorios' || tabName === 'flores' || tabName === 'arreglos') {
        renderizarArticulos(tabName);
    } else if (tabName === 'manual') {
        renderizarArticulosManuales();
    }
}

function renderizarArticulos(tipo) {
    const container = document.getElementById(`${tipo}-container`);
    if (!container) return;
    container.innerHTML = '';
    const listaArticulos = cotizacion.articulos[tipo];
    
    if (!listaArticulos) return;
    
    listaArticulos.forEach(articulo => {
        const isSelected = articulo.cantidad > 0;
        const card = document.createElement('div');
        card.className = `item-card ${isSelected ? 'selected' : ''}`;
        card.id = `${tipo}-${articulo.id}`;
        
        let detallesExtra = '';
        if (articulo.color) {
            detallesExtra = `<p style="font-size: 0.8em; color: #666;">Color: ${articulo.color}</p>`;
        }
        
        card.innerHTML = `
            <div class="item-details" onclick="toggleArticulo('${tipo}', ${articulo.id})">
                <h4>${articulo.emoji || 'üì¶'} ${articulo.nombre}</h4>
                <p>Costo unitario: ${formatoMonedaRD(articulo.precio)}</p>
                ${detallesExtra}
            </div>
            <div class="item-footer">
                <span class="price">${formatoMonedaRD(articulo.precio * articulo.cantidad)}</span>
                <div class="quantity-control">
                    <button onclick="updateCantidad('${tipo}', ${articulo.id}, -1)">-</button>
                    <input type="number" value="${articulo.cantidad}" min="0" 
                            oninput="updateCantidadInput('${tipo}', ${articulo.id}, this.value)">
                    <button onclick="updateCantidad('${tipo}', ${articulo.id}, 1)">+</button>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

function toggleArticulo(tipo, id) {
    const articulo = cotizacion.articulos[tipo].find(a => a.id === id);
    if (articulo) {
        if (articulo.cantidad > 0) {
            articulo.cantidad = 0; // Deseleccionar
        } else {
            articulo.cantidad = 1; // Seleccionar y establecer a 1
        }
        renderizarArticulos(tipo);
        actualizarResumen();
    }
}

function updateCantidad(tipo, id, cambio) {
    const articulo = cotizacion.articulos[tipo].find(a => a.id === id);
    if (articulo) {
        articulo.cantidad = Math.max(0, articulo.cantidad + cambio);
        renderizarArticulos(tipo);
        actualizarResumen();
    }
}

function updateCantidadInput(tipo, id, valor) {
    const articulo = cotizacion.articulos[tipo].find(a => a.id === id);
    if (articulo) {
        articulo.cantidad = Math.max(0, parseInt(valor) || 0);
        renderizarArticulos(tipo);
        actualizarResumen();
    }
}

// Art√≠culos Manuales
function agregarArticuloManual() {
    const newId = manualItemIdCounter++;
    cotizacion.articulos.manuales.push({
        id: newId,
        nombre: `Art√≠culo Personalizado ${newId}`,
        precioUnitario: 0,
        cantidad: 1,
        tipo: 'manual'
    });
    renderizarArticulosManuales();
    actualizarResumen();
}

function renderizarArticulosManuales() {
    const container = document.getElementById('manual-items-container');
    if (!container) return;
    container.innerHTML = '';
    
    cotizacion.articulos.manuales.forEach(item => {
        const div = document.createElement('div');
        div.className = 'manual-item';
        div.innerHTML = `
            <input type="text" placeholder="Nombre del Art√≠culo" value="${item.nombre}" 
                    oninput="actualizarArticuloManual(${item.id}, 'nombre', this.value)">
            <input type="number" placeholder="Precio Unitario" value="${item.precioUnitario}" min="0"
                    oninput="actualizarArticuloManual(${item.id}, 'precioUnitario', this.value)">
            <input type="number" placeholder="Cantidad" value="${item.cantidad}" min="1"
                    oninput="actualizarArticuloManual(${item.id}, 'cantidad', this.value)">
            <button class="btn-remove" onclick="eliminarArticuloManual(${item.id})">√ó</button>
        `;
        container.appendChild(div);
    });
}

function actualizarArticuloManual(id, campo, valor) {
    const item = cotizacion.articulos.manuales.find(a => a.id === id);
    if (item) {
        if (campo === 'nombre') {
            item.nombre = valor;
        } else {
            item[campo] = campo === 'cantidad' ? Math.max(1, parseInt(valor) || 1) : parseFloat(valor) || 0;
        }
        actualizarResumen();
    }
}

function eliminarArticuloManual(id) {
    cotizacion.articulos.manuales = cotizacion.articulos.manuales.filter(a => a.id !== id);
    renderizarArticulosManuales();
    actualizarResumen();
}

// ----------------------------------------------------
// PASO 3: C√ÅLCULOS Y RESUMEN
// ----------------------------------------------------

function actualizarCostoManual(tipo, valor) {
    let numVal = parseFloat(valor) || 0;

    if (tipo === 'transporte') {
        cotizacion.costos.transporte = numVal;
    } else if (tipo === 'manoObraPorcentaje') {
        cotizacion.costos.manoObraPorcentaje = Math.min(100, Math.max(0, numVal));
    } else if (tipo === 'manoObraMontoManual') {
        cotizacion.costos.manoObraMontoManual = numVal;
    }
    
    actualizarResumen();
    actualizarVistaPreviaPDF();
}

function contarArticulosTotales() {
    let total = 0;
    
    // Contar art√≠culos normales
    ['paquetes', 'accesorios', 'flores', 'arreglos'].forEach(tipo => {
        if (cotizacion.articulos[tipo]) {
            total += cotizacion.articulos[tipo].filter(a => a.cantidad > 0).length;
        }
    });
    
    // Contar art√≠culos manuales
    total += cotizacion.articulos.manuales.filter(a => a.cantidad > 0).length;
    
    return total;
}

function calcularTotalCotizacion() {
    let subtotalMateriales = 0;

    // 1. Sumar todos los tipos de art√≠culos
    ['paquetes', 'accesorios', 'flores', 'arreglos'].forEach(tipo => {
        if (cotizacion.articulos[tipo]) {
            cotizacion.articulos[tipo].forEach(item => {
                subtotalMateriales += item.precio * item.cantidad;
            });
        }
    });

    // 2. Sumar Art√≠culos Manuales
    cotizacion.articulos.manuales.forEach(item => {
        subtotalMateriales += (item.precioUnitario * item.cantidad);
    });

    // 3. Calcular Mano de Obra seg√∫n el tipo seleccionado
    cotizacion.costos.materiales = subtotalMateriales;
    
    let costoManoObra = 0;
    if (cotizacion.costos.tipoManoObra === 'porcentaje') {
        const porcentajeManoObra = cotizacion.costos.manoObraPorcentaje / 100;
        costoManoObra = subtotalMateriales * porcentajeManoObra;
    } else {
        costoManoObra = cotizacion.costos.manoObraMontoManual;
    }
    
    cotizacion.costos.manoObra = costoManoObra;

    // 4. Calcular Total RESPETANDO LA CONFIGURACI√ìN PDF
    let totalCalculado = subtotalMateriales;
    
    // Solo sumar mano de obra si est√° configurada para mostrarse
    if (configPDF.mostrarManoObra) {
        totalCalculado += costoManoObra;
    }
    
    // Solo sumar transporte si est√° configurado para mostrarse
    if (configPDF.mostrarTransporte) {
        totalCalculado += cotizacion.costos.transporte;
    }
    
    cotizacion.costos.total = totalCalculado;
}

function actualizarResumen() {
    calcularTotalCotizacion();

    // Actualizar Resumen de Cliente
    document.getElementById('resumen-cliente').textContent = cotizacion.cliente.nombre || '-';
    document.getElementById('resumen-evento').textContent = cotizacion.tipoEvento || '-';
    document.getElementById('resumen-fecha').textContent = cotizacion.cliente.fechaEvento || '-';
    document.getElementById('resumen-servicio').textContent = cotizacion.tipoServicio === 'flores' ? 'Flores Externas' : 'Decoraci√≥n' || '-';

    // Contar items seleccionados seg√∫n tipo de servicio
    let total1 = 0, total2 = 0;
    
    if (cotizacion.tipoServicio === 'flores') {
        total1 = cotizacion.articulos.flores.filter(a => a.cantidad > 0).length;
        total2 = cotizacion.articulos.arreglos.filter(a => a.cantidad > 0).length;
    } else {
        total1 = cotizacion.articulos.paquetes.filter(a => a.cantidad > 0).length + 
                cotizacion.articulos.manuales.filter(a => a.cantidad > 0).length;
        total2 = cotizacion.articulos.accesorios.filter(a => a.cantidad > 0).length;
    }

    document.getElementById('resumen-paquetes').textContent = `${total1} item(s)`;
    document.getElementById('resumen-accesorios').textContent = `${total2} item(s)`;
    
    // Actualizar total de art√≠culos
    document.getElementById('total-articulos').textContent = contarArticulosTotales();

    // Actualizar Resumen de Costos
    document.getElementById('resumen-materiales').textContent = formatoMonedaRD(cotizacion.costos.materiales);
    
    // Mostrar u ocultar mano de obra en el resumen seg√∫n configuraci√≥n
    const manoObraElement = document.getElementById('resumen-mano-obra');
    const transporteElement = document.getElementById('resumen-transporte');
    
    if (configPDF.mostrarManoObra) {
        manoObraElement.textContent = formatoMonedaRD(cotizacion.costos.manoObra);
        manoObraElement.parentElement.style.display = 'flex';
    } else {
        manoObraElement.parentElement.style.display = 'none';
    }
    
    if (configPDF.mostrarTransporte) {
        transporteElement.textContent = formatoMonedaRD(cotizacion.costos.transporte);
        transporteElement.parentElement.style.display = 'flex';
    } else {
        transporteElement.parentElement.style.display = 'none';
    }
    
    document.getElementById('total-cotizacion').textContent = formatoMonedaRD(cotizacion.costos.total);
    
    // Habilitar/Deshabilitar el bot√≥n de PDF
    const generarBtn = document.getElementById('generar-cotizacion');
    if (generarBtn) {
        generarBtn.disabled = cotizacion.currentStep !== 3 || cotizacion.costos.total === 0;
    }
}

// ----------------------------------------------------
// PDF GENERATION (CONSTRUCCI√ìN LIMPIA CON JSPDF)
// ----------------------------------------------------

function generarCotizacionPDF() {
    const { jsPDF } = window.jspdf;
    
    if (typeof jsPDF === 'undefined') {
        mostrarNotificaci√≥n('‚ùå Error: La librer√≠a jsPDF no se ha cargado correctamente.', 'error');
        return;
    }

    const doc = new jsPDF();
    const total = cotizacion.costos.total;
    const itemsSeleccionados = [
        ...cotizacion.articulos.paquetes.filter(p => p.cantidad > 0),
        ...cotizacion.articulos.accesorios.filter(a => a.cantidad > 0),
        ...cotizacion.articulos.flores.filter(f => f.cantidad > 0),
        ...cotizacion.articulos.arreglos.filter(arr => arr.cantidad > 0),
        ...cotizacion.articulos.manuales.filter(m => m.cantidad > 0)
    ];

    // --- Configuraci√≥n Inicial ---
    const margin = 15;
    let yPos = margin + 5;
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    const maxY = pageHeight - margin - 10;
    
    // Funci√≥n para manejar el salto de p√°gina
    function checkPageBreak(neededSpace) {
        if (yPos + neededSpace > maxY) {
            doc.addPage();
            yPos = margin;
        }
    }

    // --- ENCABEZADO ELEGANTE ---
    doc.setFillColor(138, 43, 226);
    doc.rect(0, 0, pageWidth, 35, 'F');

    // Logo con emoji (fallback si la imagen no carga)
    try {
        // Intentar cargar logo desde URL
        const logoUrl = 'https://raw.githubusercontent.com/francisdominguez/cotizador-arte-events/main/logo%20arte%20y%20eventos.png';
        doc.addImage(logoUrl, 'PNG', 20, 5, 25, 25);
    } catch (e) {
        // Si falla, usar emoji
        doc.setFontSize(24);
        doc.setTextColor(255, 255, 255);
        doc.text("üé®", 25, 18);
    }

    doc.setFontSize(18);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(255, 255, 255);
    doc.text("ARTE Y EVENTOS", pageWidth / 2, 13, { align: "center" });

    doc.setFontSize(8);
    doc.setFont("helvetica", "normal");
    doc.text("Donde los sue√±os toman forma y las emociones florecen", pageWidth / 2, 20, { align: "center" });
    doc.text("Creando magia para tus momentos especiales", pageWidth / 2, 26, { align: "center" });
    doc.text("S√≠guenos: @arteeventop", pageWidth / 2, 32, { align: "center" });

    yPos = 45;
    
    // --- INFORMACI√ìN DE LA COTIZACI√ìN ---
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    doc.text(`Fecha de Creaci√≥n: ${new Date().toLocaleDateString('es-DO')}`, pageWidth - margin, yPos + 10, { align: "right" });
    yPos += 10;

    // --- SECCI√ìN: INFORMACI√ìN DEL CLIENTE Y EVENTO ---
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(138, 43, 226);
    doc.text("Informaci√≥n del Cliente y Evento", margin, yPos);
    yPos += 7;
    
    doc.setDrawColor(200, 200, 200);
    doc.line(margin, yPos, pageWidth - margin, yPos);
    yPos += 10;

    // Informaci√≥n del cliente en dos columnas
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(0, 0, 0);
    
    // Columna izquierda
    doc.text(`Cliente: ${cotizacion.cliente.nombre || 'N/A'}`, margin, yPos);
    doc.text(`Fecha del Evento: ${formatearFecha(cotizacion.cliente.fechaEvento) || 'N/A'}`, margin, yPos + 5);
    doc.text(`Contacto: ${cotizacion.cliente.telefono || ''} / ${cotizacion.cliente.email || ''}`, margin, yPos + 10);
  
    // Columna derecha - Evento, Lugar y Tem√°tica alineados a la derecha
    const xRight = pageWidth - margin;
    doc.text(`Evento: ${cotizacion.tipoEvento || 'N/A'}`, xRight, yPos, { align: "right" });
    doc.text(`Lugar: ${cotizacion.cliente.lugarEvento || 'N/A'}`, xRight, yPos + 5, { align: "right" });
    doc.text(`Servicio: ${cotizacion.tipoServicio === 'flores' ? 'Flores Externas' : 'Decoraci√≥n'}`, xRight, yPos + 10, { align: "right" });
    
    // Mostrar Tem√°tica si existe
    if (cotizacion.tematicaEvento) {
        doc.text(`Tem√°tica: ${cotizacion.tematicaEvento}`, xRight, yPos + 15, { align: "right" });
        yPos += 20;
    } else {
        yPos += 20;
    }
    
    yPos += 5;

    // --- MODO PRESUPUESTO SIMPLE ---
    if (configPDF.mostrarPresupuestoSimple) {
        checkPageBreak(30);
        
        doc.setFillColor(245, 245, 245);
        doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
        
        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(138, 43, 226);
        doc.text("üìã PRESUPUESTO SIMPLIFICADO", margin + 5, yPos + 10);
        
        doc.setFontSize(8);
        doc.setFont("helvetica", "italic");
        doc.setTextColor(100, 100, 100);
        doc.text("(Solo se muestran los art√≠culos seleccionados sin precios individuales)", margin + 5, yPos + 15);
        
        yPos += 25;
    }

    // --- SECCI√ìN: DETALLE DE ART√çCULOS (si est√° habilitado) ---
    if (configPDF.mostrarDetalleMateriales && itemsSeleccionados.length > 0) {
        checkPageBreak(50);

        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(138, 43, 226);
        doc.text("Detalle de Art√≠culos y Servicios", margin, yPos);
        yPos += 7;

        // Encabezados de la tabla con dise√±o elegante
        doc.setFillColor(245, 245, 245);
        doc.rect(margin, yPos, pageWidth - 2 * margin, 7, 'F');
        
        doc.setFontSize(9);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(80, 80, 80);
        
        if (configPDF.mostrarPresupuestoSimple) {
            doc.text("Descripci√≥n", margin + 2, yPos + 5);
            doc.text("Cant.", pageWidth - margin - 25, yPos + 5, { align: "right" });
        } else {
            doc.text("Descripci√≥n", margin + 2, yPos + 5);
            doc.text("Cant.", pageWidth - margin - 55, yPos + 5);
            doc.text("Precio Total", pageWidth - margin - 5, yPos + 5, { align: "right" });
        }
        
        yPos += 7;

        // L√≠neas de detalle de la tabla
        doc.setFont("helvetica", "normal");
        doc.setTextColor(50, 50, 50);

        itemsSeleccionados.forEach(item => {
            checkPageBreak(5);
            const nombre = item.nombre;
            const cantidad = item.cantidad || 1;
            
            let precioUnitario;
            if (item.tipo === 'manual') {
                precioUnitario = item.precioUnitario;
            } else {
                precioUnitario = item.precio;
            }

            const precioTotalItem = precioUnitario * cantidad;

            doc.text(nombre, margin + 2, yPos + 4);
            
            if (configPDF.mostrarPresupuestoSimple) {
                doc.text(cantidad.toString(), pageWidth - margin - 25, yPos + 4, { align: "right" });
            } else {
                doc.text(cantidad.toString(), pageWidth - margin - 55, yPos + 4, { align: "right" });
                doc.text(formatoMonedaRD(precioTotalItem), pageWidth - margin - 5, yPos + 4, { align: "right" });
            }
            
            yPos += 6;
        });

        yPos += 10;
    }

    // --- SECCI√ìN: RESUMEN DE COSTOS ---
    checkPageBreak(50);
    
    // L√≠nea decorativa COMPLETA
    doc.setDrawColor(138, 43, 226);
    doc.setLineWidth(0.3);
    doc.line(margin, yPos, pageWidth - margin, yPos);
    yPos += 8;
    
    const xCostos = pageWidth - margin - 5;
    
    doc.setFontSize(10);
    
    // Mostrar Costo de Materiales si est√° habilitado
    if (configPDF.mostrarCostoMateriales) {
        doc.text("Costo de Materiales:", pageWidth / 2, yPos, { align: "left" });
        doc.text(formatoMonedaRD(cotizacion.costos.materiales), xCostos, yPos, { align: "right" });
        yPos += 5;
    }

    // MOSTRAR U OCULTAR MANO DE OBRA
    if (configPDF.mostrarManoObra) {
        let textoManoObra = "Mano de Obra:";
        if (cotizacion.costos.tipoManoObra === 'porcentaje') {
            textoManoObra = `Mano de Obra (${cotizacion.costos.manoObraPorcentaje}%):`;
        }
        
        doc.text(textoManoObra, pageWidth / 2, yPos, { align: "left" });
        doc.text(formatoMonedaRD(cotizacion.costos.manoObra), xCostos, yPos, { align: "right" });
        yPos += 5;
    }

    // MOSTRAR U OCULTAR TRANSPORTE
    if (configPDF.mostrarTransporte && cotizacion.costos.transporte > 0) {
        doc.text("Costo de Transporte:", pageWidth / 2, yPos, { align: "left" });
        doc.text(formatoMonedaRD(cotizacion.costos.transporte), xCostos, yPos, { align: "right" });
        yPos += 5;
    }
    
    yPos += 8;
    
    // L√≠nea doble antes del total
    doc.setDrawColor(138, 43, 226);
    doc.setLineWidth(0.5);
    doc.line(pageWidth / 2, yPos, pageWidth - margin, yPos);
    yPos += 1;
    doc.line(pageWidth / 2, yPos, pageWidth - margin, yPos);
    yPos += 8;

    // TOTAL FINAL con dise√±o destacado
    doc.setFillColor(245, 245, 245);
    doc.rect(pageWidth / 2 - 10, yPos - 5, pageWidth / 2 - margin + 10, 12, 'F');
    
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(138, 43, 226);
    doc.text("TOTAL COTIZADO:", pageWidth / 2, yPos, { align: "left" });
    doc.text(formatoMonedaRD(total), xCostos, yPos, { align: "right" });
    yPos += 15;
    
    // --- NOTAS (si existen) ---
    if (cotizacion.cliente.notas) {
        checkPageBreak(20);
        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(0, 0, 0);
        doc.text("Notas Adicionales:", margin, yPos);
        yPos += 4;
        
        doc.setFontSize(9);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(80, 80, 80);
        const textLines = doc.splitTextToSize(cotizacion.cliente.notas, pageWidth - 2 * margin);
        doc.text(textLines, margin, yPos);
        yPos += textLines.length * 4;
    }
    
    // --- PIE DE P√ÅGINA ELEGANTE ---
    checkPageBreak(20);
    doc.setFillColor(245, 245, 245);
    doc.rect(0, pageHeight - 20, pageWidth, 20, 'F');
    
    doc.setFontSize(8);
    doc.setFont("helvetica", "italic");
    doc.setTextColor(150, 150, 150);
    
    doc.text("Arte y Events - Decoraci√≥n Profesional", pageWidth / 2, pageHeight - 10, { align: "center" });

    // Guardar el PDF
    const nombreArchivo = `cotizacion-${cotizacion.cliente.nombre.replace(/ /g, '_') || 'arte-events'}-${new Date().getTime()}.pdf`;
    doc.save(nombreArchivo);

    // Limpiar campos despu√©s de generar la cotizaci√≥n
    limpiarCamposCotizacion();

    // Mostrar notificaci√≥n
    mostrarNotificaci√≥n('‚úÖ ¬°Cotizaci√≥n generada con √©xito!');
}

// Funci√≥n auxiliar para formatear la fecha 
function formatearFecha(fechaISO) {
    if (!fechaISO) return '';
    
    const fecha = new Date(fechaISO + 'T00:00:00');
    return fecha.toLocaleDateString('es-DO', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

// Funci√≥n para limpiar campos despu√©s de generar la cotizaci√≥n
function limpiarCamposCotizacion() {
    // Limpiar informaci√≥n del cliente
    document.getElementById('cliente-nombre').value = '';
    document.getElementById('cliente-telefono').value = '';
    document.getElementById('cliente-email').value = '';
    document.getElementById('lugar-evento').value = '';
    document.getElementById('cliente-notas').value = '';
    document.getElementById('tipo-evento').value = '';
    document.getElementById('tematica-evento').value = '';
    document.getElementById('tipo-servicio').value = '';
    document.getElementById('otro-evento').value = '';
    document.getElementById('otra-tematica').value = '';
    document.getElementById('otro-evento-container').style.display = 'none';
    document.getElementById('otra-tematica-container').style.display = 'none';
    
    // Restablecer fecha a la actual
    cargarFechaActual();
    
    // Restaurar tabs a decoraci√≥n por defecto
    cambiarTipoServicio();
    
    // Limpiar selecci√≥n de art√≠culos
    ['paquetes', 'accesorios', 'flores', 'arreglos'].forEach(tipo => {
        if (cotizacion.articulos[tipo]) {
            cotizacion.articulos[tipo].forEach(item => item.cantidad = 0);
        }
    });
    cotizacion.articulos.manuales = [];
    
    // Restablecer costos
    document.getElementById('costo-transporte').value = 0;
    document.getElementById('porcentaje-mano-obra').value = 30;
    document.getElementById('monto-mano-obra-manual').value = 0;
    document.getElementById('tipo-mano-obra').value = 'porcentaje';
    
    // Restablecer checkboxes
    document.getElementById('mostrar-presupuesto-simple').checked = false;
    document.getElementById('mostrar-mano-obra').checked = true;
    document.getElementById('mostrar-transporte').checked = true;
    document.getElementById('mostrar-detalle-materiales').checked = true;
    document.getElementById('mostrar-costo-materiales').checked = true;
    
    // Actualizar configuraci√≥n
    actualizarConfigPDF();
    
    // Actualizar la UI
    ['paquetes', 'accesorios', 'flores', 'arreglos'].forEach(tipo => {
        if (cotizacion.articulos[tipo]) {
            renderizarArticulos(tipo);
        }
    });
    renderizarArticulosManuales();
    actualizarResumen();
    actualizarVistaPreviaPDF();
    
    // Volver al paso 1
    cotizacion.currentStep = 1;
    updateStepUI();
}

// ----------------------------------------------------
// UTILIDADES Y PANEL DE CONFIGURACI√ìN
// ----------------------------------------------------

function mostrarNotificaci√≥n(mensaje, tipo = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = mensaje;
    notification.className = `notification show ${tipo === 'warning' ? 'warning' : ''} ${tipo === 'error' ? 'error' : ''}`;
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

function toggleConfig() {
    document.getElementById('configPanel').classList.toggle('active');
}

function cargarConfiguracion() {
    const configGuardada = localStorage.getItem('arteyevents_config');
    if (configGuardada) {
        const datos = JSON.parse(configGuardada);
        
        // Cargar tipos de evento
        if (datos.tiposEvento) configuracion.tiposEvento = datos.tiposEvento;
        if (datos.tematicasEvento) configuracion.tematicasEvento = datos.tematicasEvento;
        if (datos.paquetes) configuracion.paquetes = datos.paquetes;
        if (datos.accesorios) configuracion.accesorios = datos.accesorios;
        if (datos.flores) configuracion.flores = datos.flores;
        if (datos.arreglos) configuracion.arreglos = datos.arreglos;
        if (datos.manoObraPorcentaje) configuracion.manoObraPorcentaje = datos.manoObraPorcentaje;
        
        // Recopiar la estructura limpia (solo √≠tems sin cantidad) a la cotizaci√≥n
        cotizacion.articulos.paquetes = configuracion.paquetes.map(p => ({...p, cantidad: 0}));
        cotizacion.articulos.accesorios = configuracion.accesorios.map(a => ({...a, cantidad: 0}));
        cotizacion.articulos.flores = configuracion.flores.map(f => ({...f, cantidad: 0}));
        cotizacion.articulos.arreglos = configuracion.arreglos.map(arr => ({...arr, cantidad: 0}));
        cotizacion.costos.manoObraPorcentaje = configuracion.manoObraPorcentaje;
    }
}

function guardarConfiguracion() {
    // Actualizar configuracion con valores actuales
    configuracion.manoObraPorcentaje = parseFloat(document.getElementById('porcentaje-mano-obra').value) || 30;
    
    // Crear objeto para guardar
    const configToSave = {
        tiposEvento: configuracion.tiposEvento.map(({ id, nombre, emoji }) => ({ id, nombre, emoji: emoji || '‚ú®' })),
        tematicasEvento: configuracion.tematicasEvento.map(({ id, nombre, emoji }) => ({ id, nombre, emoji: emoji || 'üé®' })),
        paquetes: configuracion.paquetes.map(({ id, nombre, precio, emoji, color }) => ({ id, nombre, precio, emoji: emoji || 'üéà', color: color || '' })),
        accesorios: configuracion.accesorios.map(({ id, nombre, precio, emoji }) => ({ id, nombre, precio, emoji: emoji || '‚ú®' })),
        flores: configuracion.flores.map(({ id, nombre, precio, emoji, color }) => ({ id, nombre, precio, emoji: emoji || 'üå∏', color: color || '' })),
        arreglos: configuracion.arreglos.map(({ id, nombre, precio, emoji }) => ({ id, nombre, precio, emoji: emoji || 'üíê' })),
        manoObraPorcentaje: configuracion.manoObraPorcentaje
    };
    
    localStorage.setItem('arteyevents_config', JSON.stringify(configToSave));
    mostrarNotificaci√≥n('‚úÖ Configuraci√≥n guardada con √©xito.');
    toggleConfig();
    
    // Recargar la configuraci√≥n en la aplicaci√≥n para aplicar cambios
    cargarConfiguracion();
    cargarSelects();
    renderizarArticulos('paquetes');
    actualizarResumen();
}

function renderizarConfiguracion() {
    // Renderizar Tipos de Evento
    const configTiposContainer = document.getElementById('config-tipos-evento');
    if (configTiposContainer) {
        configTiposContainer.innerHTML = '';
        configuracion.tiposEvento.forEach(item => {
            configTiposContainer.innerHTML += createConfigItemHTML('tiposEvento', item);
        });
    }

    // Renderizar Tem√°ticas de Evento
    const configTematicasContainer = document.getElementById('config-tematicas-evento');
    if (configTematicasContainer) {
        configTematicasContainer.innerHTML = '';
        configuracion.tematicasEvento.forEach(item => {
            configTematicasContainer.innerHTML += createConfigItemHTML('tematicasEvento', item);
        });
    }

    // Renderizar Paquetes
    const configPaquetesContainer = document.getElementById('config-paquetes');
    if (configPaquetesContainer) {
        configPaquetesContainer.innerHTML = '';
        configuracion.paquetes.forEach(item => {
            configPaquetesContainer.innerHTML += createConfigItemHTML('paquetes', item);
        });
    }

    // Renderizar Accesorios
    const configAccesoriosContainer = document.getElementById('config-accesorios');
    if (configAccesoriosContainer) {
        configAccesoriosContainer.innerHTML = '';
        configuracion.accesorios.forEach(item => {
            configAccesoriosContainer.innerHTML += createConfigItemHTML('accesorios', item);
        });
    }

    // Renderizar Flores
    const configFloresContainer = document.getElementById('config-flores');
    if (configFloresContainer) {
        configFloresContainer.innerHTML = '';
        configuracion.flores.forEach(item => {
            configFloresContainer.innerHTML += createConfigItemHTML('flores', item);
        });
    }

    // Renderizar Arreglos
    const configArreglosContainer = document.getElementById('config-arreglos');
    if (configArreglosContainer) {
        configArreglosContainer.innerHTML = '';
        configuracion.arreglos.forEach(item => {
            configArreglosContainer.innerHTML += createConfigItemHTML('arreglos', item);
        });
    }
}

function createConfigItemHTML(tipo, item) {
    const esTipoEvento = tipo === 'tiposEvento' || tipo === 'tematicasEvento';
    
    return `
        <div class="config-item" data-id="${item.id}" data-tipo="${tipo}">
            <input type="text" placeholder="Nombre" value="${item.nombre}" 
                    oninput="actualizarConfigItem('${tipo}', ${item.id}, 'nombre', this.value)">
            ${esTipoEvento ? '' : `<input type="number" placeholder="Precio" value="${item.precio}" min="0" 
                    oninput="actualizarConfigItem('${tipo}', ${item.id}, 'precio', this.value)">`}
            <button class="btn-remove" onclick="eliminarConfigItem('${tipo}', ${item.id})">√ó</button>
        </div>
    `;
}

// Funciones para agregar nuevos elementos desde el panel de configuraci√≥n
function agregarTipoEvento() {
    const newId = configIdCounter++;
    configuracion.tiposEvento.push({ id: newId, nombre: `Nuevo Tipo ${newId}`, emoji: '‚ú®' });
    renderizarConfiguracion();
    cargarSelects();
}

function agregarTematicaEvento() {
    const newId = configIdCounter++;
    configuracion.tematicasEvento.push({ id: newId, nombre: `Nueva Tem√°tica ${newId}`, emoji: 'üé®' });
    renderizarConfiguracion();
    cargarSelects();
}

function agregarPaquete() {
    const newId = configIdCounter++;
    configuracion.paquetes.push({ 
        id: newId, 
        nombre: `Nuevo Globo ${newId}`, 
        precio: 0, 
        emoji: 'üéà', 
        cantidad: 0,
        color: "Mixto"
    });
    renderizarConfiguracion();
}

function agregarAccesorio() {
    const newId = configIdCounter++;
    configuracion.accesorios.push({ 
        id: newId, 
        nombre: `Nuevo Accesorio ${newId}`, 
        precio: 0, 
        emoji: '‚ú®', 
        cantidad: 0 
    });
    renderizarConfiguracion();
}

function agregarFlor() {
    const newId = configIdCounter++;
    configuracion.flores.push({ 
        id: newId, 
        nombre: `Nueva Flor ${newId}`, 
        precio: 0, 
        emoji: 'üå∏', 
        cantidad: 0,
        color: "Mixto"
    });
    renderizarConfiguracion();
}

function agregarArreglo() {
    const newId = configIdCounter++;
    configuracion.arreglos.push({ 
        id: newId, 
        nombre: `Nuevo Arreglo ${newId}`, 
        precio: 0, 
        emoji: 'üíê', 
        cantidad: 0 
    });
    renderizarConfiguracion();
}

function actualizarConfigItem(tipo, id, campo, valor) {
    const lista = configuracion[tipo];
    const item = lista.find(a => a.id === id);
    if (item) {
        if (campo === 'nombre') {
            item.nombre = valor;
        } else if (campo === 'precio') {
            item.precio = parseFloat(valor) || 0;
        }
    }
}

function eliminarConfigItem(tipo, id) {
    configuracion[tipo] = configuracion[tipo].filter(a => a.id !== id);
    renderizarConfiguracion();
    cargarSelects(); // Recargar selects si es necesario
}

// L√≥gica PWA
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
});

// Registrar Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js').then(registration => {
      console.log('Service Worker registrado: ', registration);
    }).catch(registrationError => {
      console.log('Service Worker fall√≥: ', registrationError);
    });
  });
}
